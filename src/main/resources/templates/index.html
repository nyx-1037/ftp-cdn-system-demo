<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTP-CDN文件管理系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #f8fafc;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }
        
        body {
            background-color: var(--secondary-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #1d4ed8;
            background-color: #f8fafc;
        }
        
        .upload-area.dragover {
            border-color: var(--success-color);
            background-color: #f0fdf4;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 10px 24px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        
        .table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .table thead {
            background: var(--primary-color);
            color: white;
        }
        
        .table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .file-icon {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        
        .file-icon.pdf { background: #dc2626; }
        .file-icon.doc, .file-icon.docx { background: #2563eb; }
        .file-icon.xls, .file-icon.xlsx { background: #059669; }
        .file-icon.jpg, .file-icon.jpeg, .file-icon.png, .file-icon.gif { background: #7c3aed; }
        .file-icon.zip, .file-icon.rar { background: #ea580c; }
        .file-icon.default { background: #6b7280; }
        
        .pagination {
            justify-content: center;
        }
        
        .page-link {
            border: none;
            color: var(--primary-color);
            border-radius: 6px;
            margin: 0 2px;
        }
        
        .page-item.active .page-link {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .search-box {
            border-radius: 25px;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
        }
        
        .search-box:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .copy-btn {
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        
        .copy-btn:hover {
            opacity: 1;
        }
        
        .toast {
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .upload-area {
                padding: 20px;
            }
            
            .table-responsive {
                font-size: 14px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-cloud-upload-alt me-2"></i>
                FTP-CDN文件管理系统
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/cdn">
                    <i class="fas fa-cog me-1"></i>
                    CDN配置
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 文件上传区域 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2 text-primary"></i>
                            文件上传
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="upload-area" id="uploadArea">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                        <h5>拖拽文件到此处或点击选择文件</h5>
                                        <p class="text-muted mb-0">支持最大50MB的文件上传</p>
                                        <input type="file" id="fileInput" name="file" class="d-none" required>
                                    </div>
                                    <div id="fileInfo" class="mt-3 d-none">
                                        <div class="alert alert-info">
                                            <i class="fas fa-file me-2"></i>
                                            <span id="fileName"></span>
                                            <span class="badge bg-secondary ms-2" id="fileSize"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="cdnPrefix" class="form-label">CDN前缀</label>
                                        <select class="form-select" id="cdnPrefix" name="cdnPrefix" required>
                                            <option th:each="prefix : ${cdnPrefixes}" 
                                                    th:value="${prefix.prefix}" 
                                                    th:text="${prefix.name}"
                                                    th:selected="${prefix.isDefault}">
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="description" class="form-label">文件描述</label>
                                        <textarea class="form-control" id="description" name="description" 
                                                rows="3" placeholder="请输入文件描述（可选）"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100" id="uploadBtn">
                                        <i class="fas fa-upload me-2"></i>
                                        上传文件
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索和文件列表 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2 text-primary"></i>
                            文件列表
                        </h5>
                        <div class="d-flex align-items-center">
                            <form class="d-flex" method="get">
                                <input type="search" class="form-control search-box me-2" 
                                       name="keyword" th:value="${keyword}" 
                                       placeholder="搜索文件名或描述..." style="width: 250px;">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>文件</th>
                                        <th>原始文件名</th>
                                        <th>文件大小</th>
                                        <th>描述</th>
                                        <th>CDN链接</th>
                                        <th>上传时间</th>
                                        <th>下载次数</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="file : ${pageInfo.list}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="file-icon me-2" 
                                                      th:classappend="${#strings.toLowerCase(#strings.substring(file.fileExtension, 1))}"
                                                      th:if="${file.fileExtension != null and file.fileExtension != ''}">
                                                    <i class="fas fa-file"></i>
                                                </span>
                                                <span class="file-icon default me-2" th:unless="${file.fileExtension != null and file.fileExtension != ''}">
                                                    <i class="fas fa-file"></i>
                                                </span>
                                                <span th:text="${file.generatedFileName}" class="text-muted small"></span>
                                            </div>
                                        </td>
                                        <td th:text="${file.originalFileName}"></td>
                                        <td>
                                            <span th:text="${#numbers.formatDecimal(file.fileSize / 1024.0, 1, 1)} + ' KB'"
                                                  th:if="${file.fileSize < 1024 * 1024}"></span>
                                            <span th:text="${#numbers.formatDecimal(file.fileSize / (1024.0 * 1024.0), 1, 1)} + ' MB'"
                                                  th:if="${file.fileSize >= 1024 * 1024}"></span>
                                        </td>
                                        <td>
                                            <span th:text="${file.description}" th:if="${file.description != null and file.description != ''}"></span>
                                            <span class="text-muted" th:unless="${file.description != null and file.description != ''}">无描述</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <input type="text" class="form-control form-control-sm me-2" 
                                                       th:value="${file.fullUrl}" readonly style="width: 200px;">
                                                <button class="btn btn-sm btn-outline-primary copy-btn" 
                                                        th:data-url="${file.fullUrl}"
                                                        onclick="copyToClipboard(this.getAttribute('data-url'))"
                                                        title="复制链接">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td th:text="${#temporals.format(file.uploadTime, 'yyyy-MM-dd HH:mm')}"></td>
                                        <td>
                                            <span class="badge bg-info" th:text="${file.downloadCount}"></span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a th:href="@{'/file/' + ${file.id}}" class="btn btn-outline-primary" title="查看详情">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button class="btn btn-outline-success" 
                                                        th:data-id="${file.id}"
                                                        onclick="downloadFile(this.getAttribute('data-id'))"
                                                        title="下载文件">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" 
                                                        th:data-id="${file.id}"
                                                        onclick="deleteFile(this.getAttribute('data-id'))"
                                                        title="删除文件">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(pageInfo.list)}">
                                        <td colspan="8" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <div>暂无文件数据</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 分页 -->
                    <div class="card-footer bg-white" th:if="${pageInfo.pages > 1}">
                        <nav>
                            <ul class="pagination mb-0">
                                <li class="page-item" th:classappend="${!pageInfo.hasPreviousPage} ? 'disabled'">
                                    <a class="page-link" th:href="@{/(page=${pageInfo.prePage}, keyword=${keyword})}" 
                                       th:if="${pageInfo.hasPreviousPage}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                    <span class="page-link" th:unless="${pageInfo.hasPreviousPage}">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                </li>
                                
                                <li class="page-item" th:each="num : ${pageInfo.navigatepageNums}" 
                                    th:classappend="${num == pageInfo.pageNum} ? 'active'">
                                    <a class="page-link" th:href="@{/(page=${num}, keyword=${keyword})}" 
                                       th:text="${num}" th:if="${num != pageInfo.pageNum}"></a>
                                    <span class="page-link" th:text="${num}" th:if="${num == pageInfo.pageNum}"></span>
                                </li>
                                
                                <li class="page-item" th:classappend="${!pageInfo.hasNextPage} ? 'disabled'">
                                    <a class="page-link" th:href="@{/(page=${pageInfo.nextPage}, keyword=${keyword})}" 
                                       th:if="${pageInfo.hasNextPage}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                    <span class="page-link" th:unless="${pageInfo.hasNextPage}">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </li>
                            </ul>
                        </nav>
                        
                        <div class="text-center mt-2 text-muted small">
                            共 <span th:text="${pageInfo.total}"></span> 个文件，
                            第 <span th:text="${pageInfo.pageNum}"></span> / <span th:text="${pageInfo.pages}"></span> 页
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">系统通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- 消息内容 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // 文件上传相关功能
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadForm = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');

        // 点击上传区域选择文件
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // 拖拽上传
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                showFileInfo(files[0]);
            }
        });

        // 文件选择
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                showFileInfo(e.target.files[0]);
            }
        });

        // 显示文件信息
        function showFileInfo(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('d-none');
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // 文件上传
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(uploadForm);
            
            // 验证文件
            if (!fileInput.files.length) {
                showToast('请选择要上传的文件', 'warning');
                return;
            }
            
            // 禁用上传按钮
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>上传中...';
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('文件上传成功！', 'success');
                    // 重置表单
                    uploadForm.reset();
                    fileInfo.classList.add('d-none');
                    // 刷新页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(result.message || '文件上传失败', 'error');
                }
            } catch (error) {
                showToast('网络错误，请重试', 'error');
            } finally {
                // 恢复上传按钮
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>上传文件';
            }
        });

        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('链接已复制到剪贴板', 'success');
            }).catch(() => {
                showToast('复制失败，请手动复制', 'error');
            });
        }

        // 下载文件
        function downloadFile(fileId) {
            // 直接跳转到下载接口，浏览器会自动处理下载
            window.location.href = `/file/${fileId}/download`;
        }

        // 删除文件
        function deleteFile(fileId) {
            if (confirm('确定要删除这个文件吗？此操作不可恢复。')) {
                fetch(`/file/${fileId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showToast('文件删除成功', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showToast(result.message || '文件删除失败', 'error');
                    }
                })
                .catch(() => {
                    showToast('网络错误，请重试', 'error');
                });
            }
        }

        // 显示Toast通知
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = toast.querySelector('.toast-header');
            
            // 设置消息内容
            toastMessage.textContent = message;
            
            // 设置图标和颜色
            const icon = toastHeader.querySelector('i');
            icon.className = 'me-2 ';
            
            switch (type) {
                case 'success':
                    icon.className += 'fas fa-check-circle text-success';
                    break;
                case 'error':
                    icon.className += 'fas fa-exclamation-circle text-danger';
                    break;
                case 'warning':
                    icon.className += 'fas fa-exclamation-triangle text-warning';
                    break;
                default:
                    icon.className += 'fas fa-info-circle text-primary';
            }
            
            // 显示Toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    </script>
</body>
</html>